name: telegram github quiz
on: 
  schedule:
    - cron: "0 */10 * * *"
    # Each 10hours to have at least 2 quiz questions per day (24h)
    # Note that this cron value will influence the behavior of the report_quiz
    # make sure to check the overall working after each modification

jobs:
  build:
    defaults:
      run:
        working-directory: ./.github/workflows/report_quiz

    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Config the environment variable
        shell: bash
        run: |
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >>> env.sh
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_OSSCAMEROON_GROUP_ID }}" >>> env.sh
          echo "QUIZAPI_KEY=${{ secrets.QUIZAPI_KEY }}" >>> env.sh
      
      - name: Load the database
        uses: actions/checkout@master
        with:
          repository: osscameroon/reportquiz_data
          path: .

      - name: Send quiz to the group
        shell: bash
        run: |
          source main.sh
          # send a new quiz
          send_quiz
      
      - name: Fetch quizzes user answers
        shell: bash
        run: |
          source main.sh
          # update the quiz database
          fetch_quiz_user_answers
      
      - name: Check the status of the competition
        shell: bash
        run: |
          source main.sh
          # start a new competition each monday morning
          if [ $(date +%a_%p) == Mon_AM ]; then start_quiz_competition; fi
          # end the competition each sunday evening
          if [ $(date +%a_%p) == Sun_PM ]; then stop_quiz_competition; fi

      - name: Update the database
        shell: bash
        run: |
          if git status archive database --ignored; then
            if [ -d database ]; then git add database -f; fi
            if [ -d archive ]; then git add archive -f; fi
            git commit -m "update"
            git push origin main
          fi

